<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Proyek C2</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Memuat FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    
    <style>
        /* Sembunyikan view/page secara default */
        .page-content {
            display: none;
        }
        /* Tampilkan page yang aktif */
        .page-content.active {
            display: block;
        }
        /* Kustomisasi scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Kustomisasi FullCalendar agar responsif */
        :root {
            --fc-font-size: 0.8em;
        }
        @media (min-width: 768px) {
            :root {
                --fc-font-size: 1em;
            }
        }
        .fc {
            max-width: 100%;
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal" style="font-family: 'Inter', sans-serif;">

    <!-- Latar belakang gradien -->
    <div class="absolute inset-0 -z-10 h-full w-full bg-white bg-[linear-gradient(to_right,#f0f0f0_1px,transparent_1px),linear-gradient(to_bottom,#f0f0f0_1px,transparent_1px)] bg-[size:6rem_4rem]"></div>

    <!-- Tampilan Login -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Dasbor Proyek C2</h2>
            <p class="text-center text-gray-500 mb-6">Silakan pilih nama Anda untuk masuk.</p>
            
            <div class="space-y-4">
                <div>
                    <label for="username-select" class="block text-sm font-medium text-gray-700">Nama Anggota</label>
                    <select id="username-select" class="mt-1 block w-full py-3 px-4 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg">
                        <option value="Dhanu">Dhanu</option>
                        <option value="Hisyam">Hisyam</option>
                        <option value="Dava">Dava</option>
                        <option value="Nezya">Nezya</option>
                        <option value="Andin">Andin</option>
                    </select>
                </div>
                
                <button id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1">
                    Masuk
                </button>
            </div>
        </div>
    </div>

    <!-- Tampilan Aplikasi Utama (tersembunyi) -->
    <div id="app-view" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar (Desktop) -->
            <aside class="w-64 bg-white shadow-lg hidden md:block">
                <div class="p-6">
                    <h1 class="text-2xl font-bold text-blue-600">Proyek C2</h1>
                </div>
                <nav class="mt-6">
                    <a href="#" data-page="dashboard-page" class="nav-link flex items-center mt-4 py-3 px-6 text-gray-700 bg-gray-200 rounded-lg mx-2 font-semibold">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                        <span class="mx-3">Dasbor</span>
                    </a>
                    <a href="#" data-page="todo-page" class="nav-link flex items-center mt-4 py-3 px-6 text-gray-500 hover:bg-gray-200 rounded-lg mx-2 transition duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span class="mx-3">To-Do List</span>
                    </a>
                    <a href="#" data-page="timeline-page" class="nav-link flex items-center mt-4 py-3 px-6 text-gray-500 hover:bg-gray-200 rounded-lg mx-2 transition duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span class="mx-3">Timeline</span>
                    </a>
                </nav>
                <div class="absolute bottom-0 w-64 p-4">
                    <button id="logout-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Keluar
                    </button>
                </div>
            </aside>

            <!-- Konten Utama -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Header (Mobile/Desktop) -->
                <header class="flex justify-between items-center p-4 bg-white shadow-md">
                    <!-- Tombol Menu Mobile -->
                    <button id="mobile-menu-button" class="text-gray-600 focus:outline-none md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h2 id="page-title" class="text-2xl font-semibold text-gray-800">Dasbor</h2>
                    <div class="flex items-center">
                        <span class="text-gray-700">Selamat datang, <strong id="welcome-username" class="font-bold"></strong>!</span>
                    </div>
                </header>

                <!-- Menu Navigasi Mobile (tersembunyi) -->
                <div id="mobile-menu" class="hidden md:hidden bg-white shadow-lg">
                    <nav class="mt-2 pb-4">
                        <a href="#" data-page="dashboard-page" class="nav-link-mobile flex items-center mt-2 py-3 px-6 text-gray-700 bg-gray-200 font-semibold">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                            <span class="mx-3">Dasbor</span>
                        </a>
                        <a href="#" data-page="todo-page" class="nav-link-mobile flex items-center mt-2 py-3 px-6 text-gray-500 hover:bg-gray-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                            <span class="mx-3">To-Do List</span>
                        </a>
                        <a href="#" data-page="timeline-page" class="nav-link-mobile flex items-center mt-2 py-3 px-6 text-gray-500 hover:bg-gray-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span class="mx-3">Timeline</span>
                        </a>
                    </nav>
                </div>

                <!-- Area Konten Utama dengan Scroll -->
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-6">
                    
                    <!-- Halaman Dasbor -->
                    <div id="dashboard-page" class="page-content active">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            
                            <!-- Update Terbaru -->
                            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Update Terbaru</h3>
                                <div id="updates-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                    <!-- Konten dinamis dari JS -->
                                    <p class="text-gray-500">Memuat update...</p>
                                </div>
                            </div>
                            
                            <!-- Anggota Online -->
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Anggota Online</h3>
                                <div id="online-list" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- Konten dinamis dari JS -->
                                    <p class="text-gray-500">Memuat anggota...</p>
                                </div>
                            </div>

                            <!-- Analisa Chart -->
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Analisis Tugas</h3>
                                <div class="h-64 flex items-center justify-center">
                                    <canvas id="tasks-chart"></canvas>
                                </div>
                            </div>

                            <!-- List Dashboard (Nama & Link) -->
                            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Tautan Penting</h3>
                                <form id="add-link-form" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                                    <input type="text" id="link-name" placeholder="Nama Tautan" class="sm:col-span-1 p-2 border rounded-lg" required>
                                    <input type="url" id="link-url" placeholder="URL (https://...)" class="sm:col-span-1 p-2 border rounded-lg" required>
                                    <button type="submit" class="sm:col-span-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Tambah</button>
                                </form>
                                <div id="links-list" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                                    <!-- Konten dinamis dari JS -->
                                    <p class="text-gray-500">Belum ada tautan.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Halaman To-Do List -->
                    <div id="todo-page" class="page-content">
                        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Tambah Tugas Baru</h3>
                            <p class="text-gray-600 mb-4">Tugas baru akan otomatis ditugaskan kepada Anda (<span id="todo-pic" class="font-semibold"></span>).</p>
                            <form id="add-todo-form" class="space-y-4">
                                <input type="text" id="todo-name" placeholder="Nama Tugas" class="w-full p-3 border rounded-lg" required>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="date" id="todo-start" title="Tanggal Mulai" class="w-full p-3 border rounded-lg" required>
                                    <input type="date" id="todo-deadline" title="Tanggal Selesai" class="w-full p-3 border rounded-lg" required>
                                </div>
                                <select id="todo-progress" class="w-full p-3 border rounded-lg bg-white" required>
                                    <option value="Direncanakan">Direncanakan</option>
                                    <option value="On Going">On Going</option>
                                    <option value="On Review">On Review</option>
                                    <option value="Done">Done</option>
                                </select>
                                <input type="text" id="todo-link" placeholder="Link Dokumen / Deskripsi" class="w-full p-3 border rounded-lg">
                                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">Tambah Tugas</button>
                            </form>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Daftar Tugas Anggota</h3>
                            <!-- Tab Anggota -->
                            <div class="border-b border-gray-200">
                                <nav id="todo-member-tabs" class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Tabs">
                                    <!-- Tab dinamis dari JS -->
                                </nav>
                            </div>
                            
                            <!-- Kolom Kanban -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4 min-h-[300px]">
                                <div class="bg-gray-100 p-4 rounded-lg">
                                    <h4 class="font-bold text-gray-700 mb-3 text-center">Direncanakan</h4>
                                    <div id="todo-col-Direncanakan" class="space-y-3"></div>
                                </div>
                                <div class="bg-gray-100 p-4 rounded-lg">
                                    <h4 class="font-bold text-blue-700 mb-3 text-center">On Going</h4>
                                    <div id="todo-col-On Going" class="space-y-3"></div>
                                </div>
                                <div class="bg-gray-100 p-4 rounded-lg">
                                    <h4 class="font-bold text-purple-700 mb-3 text-center">On Review</h4>
                                    <div id="todo-col-On Review" class="space-y-3"></div>
                                </div>
                                <div class="bg-gray-100 p-4 rounded-lg">
                                    <h4 class="font-bold text-green-700 mb-3 text-center">Done</h4>
                                    <div id="todo-col-Done" class="space-y-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Halaman Timeline -->
                    <div id="timeline-page" class="page-content">
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Timeline Tugas</h3>
                            
                            <!-- Pilih Anggota -->
                            <div class="mb-4 max-w-sm">
                                <label for="timeline-member-select" class="block text-sm font-medium text-gray-700">Lihat Timeline Untuk:</label>
                                <select id="timeline-member-select" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <!-- Opsi dinamis dari JS -->
                                </select>
                            </div>
                            
                            <!-- Kontainer Kalender -->
                            <div id="calendar-container"></div>
                        </div>
                    </div>

                </main>
            </div>
        </div>
    </div>

    <!-- Modal untuk detail tugas (opsional, bisa ditambahkan) -->
    <!-- ... -->

    <!-- Skrip Aplikasi -->
    <script type="module">
        // Import fungsi Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            onSnapshot, 
            serverTimestamp,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabel Global ---
        
        // Konfigurasi Firebase dari environment
        // !! PENTING: Gunakan __firebase_config yang disediakan oleh Canvas
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Inisialisasi Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase Berhasil Diinisialisasi.");
        } catch (e) {
            console.error("Error inisialisasi Firebase:", e);
            document.body.innerHTML = '<h1 class="text-red-500 text-center p-8">Error Konfigurasi Firebase. Periksa console.</h1>';
        }

        // Variabel State Aplikasi
        let currentUsername = null;
        let currentUserId = null;
        let myChart = null;
        let calendar = null;
        let allTodos = [];
        const teamMembers = ["Dhanu", "Hisyam", "Dava", "Nezya", "Andin"];
        let presenceInterval = null; // Untuk update presence
        let unsubscribeListeners = []; // Untuk menyimpan fungsi unsubscribe

        // --- Referensi DOM ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const usernameSelect = document.getElementById('username-select');
        const welcomeUsername = document.getElementById('welcome-username');
        const pageTitle = document.getElementById('page-title');
        
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        
        // Konten Halaman
        const pageContents = document.querySelectorAll('.page-content');
        const navLinks = document.querySelectorAll('.nav-link, .nav-link-mobile');

        // Dasbor
        const updatesList = document.getElementById('updates-list');
        const onlineList = document.getElementById('online-list');
        const linksList = document.getElementById('links-list');
        const addLinkForm = document.getElementById('add-link-form');
        const tasksChartCanvas = document.getElementById('tasks-chart');

        // To-Do
        const addTodoForm = document.getElementById('add-todo-form');
        const todoPic = document.getElementById('todo-pic');
        const todoMemberTabs = document.getElementById('todo-member-tabs');
        
        // Timeline
        const calendarContainer = document.getElementById('calendar-container');
        const timelineMemberSelect = document.getElementById('timeline-member-select');

        // --- Path Firestore ---
        // Menggunakan path 'public' sesuai instruksi untuk kolaborasi
        const getCollectionPath = (collectionName) => `artifacts/${appId}/public/data/${collectionName}`;
        const presenceCollection = collection(db, getCollectionPath('presence'));
        const updatesCollection = collection(db, getCollectionPath('updates'));
        const linksCollection = collection(db, getCollectionPath('dashboardLinks'));
        const todosCollection = collection(db, getCollectionPath('todos'));

        // --- Inisialisasi Firebase Auth ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Auth state changed, user ID:", user.uid);
                currentUserId = user.uid;
            } else {
                console.log("No user signed in, attempting sign in...");
                try {
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with Custom Token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in Anonymously.");
                    }
                } catch (error) {
                    console.error("Error signing in:", error);
                }
            }
        });

        // --- Logika Login/Logout ---
        loginButton.addEventListener('click', () => {
            if (!currentUserId) {
                console.error("User ID belum siap. Coba lagi.");
                alert("Autentikasi belum siap. Silakan tunggu beberapa detik dan coba lagi.");
                return;
            }
            
            currentUsername = usernameSelect.value;
            welcomeUsername.textContent = currentUsername;
            todoPic.textContent = currentUsername;
            
            loginView.style.display = 'none';
            appView.style.display = 'block';

            startApp();
        });

        logoutButton.addEventListener('click', () => {
            stopApp();
            currentUsername = null;
            loginView.style.display = 'flex';
            appView.style.display = 'none';
        });

        // --- Logika Navigasi ---
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.getAttribute('data-page');
                
                // Sembunyikan semua halaman
                pageContents.forEach(page => page.classList.remove('active'));
                
                // Tampilkan halaman yang diklik
                const activePage = document.getElementById(pageId);
                if (activePage) {
                    activePage.classList.add('active');
                }

                // Update judul halaman
                pageTitle.textContent = link.querySelector('span').textContent;

                // Update style link aktif
                document.querySelectorAll('.nav-link, .nav-link-mobile').forEach(nav => {
                    nav.classList.remove('bg-gray-200', 'font-semibold', 'text-gray-700');
                    nav.classList.add('text-gray-500');
                });
                // Targetkan link desktop dan mobile untuk pageId yang sama
                document.querySelectorAll(`.nav-link[data-page="${pageId}"], .nav-link-mobile[data-page="${pageId}"]`).forEach(activeLink => {
                    activeLink.classList.add('bg-gray-200', 'font-semibold', 'text-gray-700');
                    activeLink.classList.remove('text-gray-500');
                });

                // Sembunyikan menu mobile setelah diklik
                mobileMenu.classList.add('hidden');
                
                // Render ulang kalender jika halaman timeline dibuka
                if (pageId === 'timeline-page' && calendar) {
                    setTimeout(() => calendar.render(), 0);
                }
            });
        });
        
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // --- Fungsi Utama Aplikasi ---
        function startApp() {
            console.log(`Memulai aplikasi sebagai ${currentUsername}`);
            
            // Inisialisasi komponen
            initDashboard();
            initTodoPage();
            initTimelinePage();
            
            // Mulai listener
            startAllListeners();
            
            // Atur presence
            updatePresence();
            if (presenceInterval) clearInterval(presenceInterval);
            presenceInterval = setInterval(updatePresence, 60 * 1000); // Update tiap 1 menit
            
            // Hapus doc presence saat tab ditutup (best effort)
            window.addEventListener('beforeunload', clearPresence);
        }
        
        function stopApp() {
            console.log("Menghentikan aplikasi.");
            // Hentikan interval presence
            if (presenceInterval) clearInterval(presenceInterval);
            presenceInterval = null;
            
            // Hapus doc presence
            clearPresence();
            
            // Hentikan semua listener
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            
            // Reset state
            allTodos = [];
            if (myChart) {
                myChart.data.datasets[0].data = [0, 0, 0, 0];
                myChart.update();
            }
            if (calendar) {
                calendar.removeAllEvents();
            }
        }

        // --- Logika Presence ---
        async function updatePresence() {
            if (!currentUsername) return;
            const presenceRef = doc(db, getCollectionPath('presence'), currentUsername);
            try {
                await setDoc(presenceRef, { 
                    lastSeen: serverTimestamp(),
                    username: currentUsername 
                });
            } catch (e) {
                console.error("Gagal update presence:", e);
            }
        }

        async function clearPresence() {
            if (!currentUsername) return;
            const presenceRef = doc(db, getCollectionPath('presence'), currentUsername);
            try {
                await deleteDoc(presenceRef);
                console.log("Presence dihapus.");
            } catch (e) {
                console.error("Gagal hapus presence:", e);
            }
        }

        // --- Inisialisasi Halaman ---
        function initDashboard() {
            // Inisialisasi Chart
            if (myChart) myChart.destroy();
            const ctx = tasksChartCanvas.getContext('2d');
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Direncanakan', 'On Going', 'On Review', 'Done'],
                    datasets: [{
                        label: 'Status Tugas',
                        data: [0, 0, 0, 0], // Akan diisi oleh listener
                        backgroundColor: [
                            'rgba(107, 114, 128, 0.7)', // gray-500
                            'rgba(59, 130, 246, 0.7)',  // blue-500
                            'rgba(168, 85, 247, 0.7)', // purple-500
                            'rgba(16, 185, 129, 0.7)'   // green-500
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });

            // Listener Form Tautan
            addLinkForm.onsubmit = async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('link-name');
                const urlInput = document.getElementById('link-url');
                
                try {
                    await addDoc(linksCollection, {
                        name: nameInput.value,
                        url: urlInput.value,
                        addedBy: currentUsername
                    });
                    
                    await addUpdate(`${currentUsername} menambahkan tautan baru: ${nameInput.value}`);
                    
                    nameInput.value = '';
                    urlInput.value = '';
                } catch (e) {
                    console.error("Gagal tambah tautan:", e);
                }
            };
        }

        function initTodoPage() {
            // Isi tab anggota
            todoMemberTabs.innerHTML = '';
            teamMembers.forEach((member, index) => {
                const isActive = index === 0;
                todoMemberTabs.innerHTML += `
                    <a href="#" data-member="${member}" 
                       class="todo-tab ${isActive ? 'border-blue-500 text-blue-600 font-semibold' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-3 px-1 border-b-2 text-sm">
                        ${member}
                    </a>
                `;
            });
            // Tetapkan member aktif pertama
            todoMemberTabs.dataset.activeMember = teamMembers[0];

            // Listener klik tab
            todoMemberTabs.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('.todo-tab');
                if (!target) return;
                
                document.querySelectorAll('.todo-tab').forEach(tab => {
                    tab.classList.remove('border-blue-500', 'text-blue-600', 'font-semibold');
                    tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });
                
                target.classList.add('border-blue-500', 'text-blue-600', 'font-semibold');
                target.classList.remove('border-transparent', 'text-gray-500');
                
                const member = target.dataset.member;
                todoMemberTabs.dataset.activeMember = member;
                renderTodos(member);
            });

            // Listener Form To-Do
            addTodoForm.onsubmit = async (e) => {
                e.preventDefault();
                const task = {
                    name: document.getElementById('todo-name').value,
                    pic: currentUsername,
                    start: document.getElementById('todo-start').value,
                    deadline: document.getElementById('todo-deadline').value,
                    progress: document.getElementById('todo-progress').value,
                    link: document.getElementById('todo-link').value,
                    createdAt: serverTimestamp()
                };

                try {
                    await addDoc(todosCollection, task);
                    await addUpdate(`${currentUsername} menambahkan tugas baru: ${task.name}`);
                    addTodoForm.reset();
                } catch (e) {
                    console.error("Gagal tambah tugas:", e);
                }
            };
        }
        
        function initTimelinePage() {
            // Isi dropdown member
            timelineMemberSelect.innerHTML = '';
            teamMembers.forEach(member => {
                timelineMemberSelect.innerHTML += `<option value="${member}">${member}</option>`;
            });

            // Inisialisasi Kalender
            if (calendar) calendar.destroy();
            calendar = new FullCalendar.Calendar(calendarContainer, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                events: [], // Akan diisi oleh listener
                editable: false,
                selectable: false,
                height: 'auto'
            });
            calendar.render();
            
            // Listener ganti member
            timelineMemberSelect.onchange = () => {
                renderCalendar(timelineMemberSelect.value);
            };
        }

        // --- Listener Data Firestore ---
        function startAllListeners() {
            // Hentikan listener lama jika ada
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            
            // Listener Presence
            const presenceQuery = query(presenceCollection);
            const unsubPresence = onSnapshot(presenceQuery, (snapshot) => {
                const now = Date.now();
                const online = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const lastSeen = data.lastSeen?.toDate().getTime();
                    if (lastSeen && (now - lastSeen) < 2 * 60 * 1000) { // 2 menit
                        online.push(data.username);
                    }
                });
                renderOnlineMembers(online);
            }, (err) => console.error("Error listener presence:", err));
            unsubscribeListeners.push(unsubPresence);

            // Listener Updates
            // Mengambil 20 update terbaru, diurutkan di client
            const updatesQuery = query(updatesCollection);
            const unsubUpdates = onSnapshot(updatesQuery, (snapshot) => {
                let updates = [];
                snapshot.forEach(doc => updates.push({ id: doc.id, ...doc.data() }));
                // Urutkan di client (Descending)
                updates.sort((a, b) => b.timestamp?.toMillis() - a.timestamp?.toMillis());
                updates = updates.slice(0, 20); // Ambil 20 terbaru
                renderUpdates(updates);
            }, (err) => console.error("Error listener updates:", err));
            unsubscribeListeners.push(unsubUpdates);

            // Listener Links
            const linksQuery = query(linksCollection);
            const unsubLinks = onSnapshot(linksQuery, (snapshot) => {
                let links = [];
                snapshot.forEach(doc => links.push({ id: doc.id, ...doc.data() }));
                renderLinks(links);
            }, (err) => console.error("Error listener links:", err));
            unsubscribeListeners.push(unsubLinks);

            // Listener To-Dos
            const todosQuery = query(todosCollection);
            const unsubTodos = onSnapshot(todosQuery, (snapshot) => {
                allTodos = [];
                snapshot.forEach(doc => allTodos.push({ id: doc.id, ...doc.data() }));
                
                // Update semua komponen yang bergantung pada todos
                const activeMemberTodo = todoMemberTabs.dataset.activeMember;
                renderTodos(activeMemberTodo);
                
                const activeMemberTimeline = timelineMemberSelect.value;
                renderCalendar(activeMemberTimeline);
                
                updateChart();
            }, (err) => console.error("Error listener todos:", err));
            unsubscribeListeners.push(unsubTodos);
        }

        // --- Fungsi Render ---
        function renderOnlineMembers(online) {
            if (online.length === 0) {
                onlineList.innerHTML = '<p class="text-gray-500">Tidak ada yang online.</p>';
                return;
            }
            onlineList.innerHTML = online.map(name => `
                <div class="flex items-center space-x-2">
                    <span class="h-3 w-3 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-gray-700">${name}</span>
                </div>
            `).join('');
        }

        function renderUpdates(updates) {
            if (updates.length === 0) {
                updatesList.innerHTML = '<p class="text-gray-500">Belum ada update.</p>';
                return;
            }
            updatesList.innerHTML = updates.map(update => `
                <div class="border-l-4 border-blue-400 pl-3 py-1">
                    <p class="text-sm text-gray-800">${update.text}</p>
                    <p class="text-xs text-gray-500">${new Date(update.timestamp?.toDate()).toLocaleString('id-ID')}</p>
                </div>
            `).join('');
        }

        function renderLinks(links) {
            if (links.length === 0) {
                linksList.innerHTML = '<p class="text-gray-500">Belum ada tautan.</p>';
                return;
            }
            linksList.innerHTML = links.map(link => `
                <div class="flex justify-between items-center p-2 rounded-lg hover:bg-gray-50">
                    <span class="text-gray-800">${link.name} (oleh ${link.addedBy})</span>
                    <a href="${link.url}" target="_blank" rel="noopener noreferrer" 
                       class="text-blue-500 hover:text-blue-700 font-semibold px-3 py-1 rounded-full text-sm">
                        Kunjungi &rarr;
                    </a>
                </div>
            `).join('');
        }

        function renderTodos(memberName) {
            // Kosongkan semua kolom
            document.getElementById('todo-col-Direncanakan').innerHTML = '';
            document.getElementById('todo-col-On Going').innerHTML = '';
            document.getElementById('todo-col-On Review').innerHTML = '';
            document.getElementById('todo-col-Done').innerHTML = '';
            
            const memberTodos = allTodos.filter(todo => todo.pic === memberName);
            
            if (memberTodos.length === 0) {
                document.getElementById('todo-col-Direncanakan').innerHTML = '<p class="text-sm text-gray-500 text-center">Tidak ada tugas.</p>';
            }

            memberTodos.forEach(todo => {
                const todoCard = `
                    <div class="bg-white p-3 rounded-lg shadow-md border border-gray-200">
                        <h5 class="font-semibold text-gray-900 mb-1">${todo.name}</h5>
                        <p class="text-xs text-gray-500 mb-2">
                            ${todo.start} s/d ${todo.deadline}
                        </p>
                        ${todo.link ? `<a href="${todo.link.startsWith('http') ? todo.link : ''}" target="_blank" rel="noopener noreferrer" class="text-xs text-blue-600 block truncate mb-2 hover:underline">${todo.link}</a>` : ''}
                        
                        <!-- Di sini bisa tambahkan tombol edit/update progress -->
                    </div>
                `;
                const container = document.getElementById(`todo-col-${todo.progress}`);
                if (container) {
                    container.innerHTML += todoCard;
                }
            });
        }
        
        function renderCalendar(memberName) {
            if (!calendar) return;
            
            const memberTodos = allTodos.filter(todo => todo.pic === memberName);
            const events = memberTodos.map(todo => {
                // FullCalendar perlu 'end' eksklusif, jadi tambah 1 hari
                let endDate = new Date(todo.deadline);
                endDate.setDate(endDate.getDate() + 1);
                
                let color = '#718096'; // gray
                if (todo.progress === 'On Going') color = '#3B82F6'; // blue
                if (todo.progress === 'On Review') color = '#A855F7'; // purple
                if (todo.progress === 'Done') color = '#10B981'; // green

                return {
                    title: todo.name,
                    start: todo.start,
                    end: endDate.toISOString().split('T')[0],
                    backgroundColor: color,
                    borderColor: color
                };
            });
            
            calendar.removeAllEvents();
            calendar.addEventSource(events);
        }

        function updateChart() {
            if (!myChart) return;
            
            const counts = {
                'Direncanakan': 0,
                'On Going': 0,
                'On Review': 0,
                'Done': 0
            };
            
            allTodos.forEach(todo => {
                if (counts.hasOwnProperty(todo.progress)) {
                    counts[todo.progress]++;
                }
            });
            
            myChart.data.datasets[0].data = [
                counts['Direncanakan'],
                counts['On Going'],
                counts['On Review'],
                counts['Done']
            ];
            myChart.update();
        }
        
        // --- Helper & Utility ---
        async function addUpdate(text) {
            try {
                await addDoc(updatesCollection, {
                    text: text,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Gagal menambah update:", e);
            }
        }

    </script>

</body>
</html>
